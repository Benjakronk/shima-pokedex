<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©dex Search</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #e3350d;
            text-align: center;
        }
        nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        button {
            background-color: #30a7d7;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #1b82b1;
        }
        input[type="text"], select {
            padding: 10px;
            margin-right: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .pokemon-card, .move-card {
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }
        .pokemon-card:hover, .move-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pagination-controls button {
            background-color: #ffcb05;
            color: #333;
        }
        .pagination-controls button:hover {
            background-color: #e6b400;
        }
    </style>
</head>
<body>
    <audio id="loadingCompleteSound" src="https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/SFX_TURN_ON_PC.wav" preload="auto"></audio>
    <audio id="searchSelect" src="https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/SFX_PRESS_AB.wav" preload="auto"></audio>
    <h1>Pok√©dex Search</h1>
    <nav>
        <button id="pokedex_button" onclick="showPokemonSearch()" style="display: none;">Pok√©dex Search</button>
        <button id="move_button" onclick="showMoveSearch()" style="display: none;">Move Database</button>
    </nav>

    <div id="pokemonSearch" style="display: none;">
        <div id="filters">
            <select id="typeFilter"><option value="">All Types</option></select>
            <select id="sizeFilter"><option value="">All Sizes</option></select>
            <select id="behaviorFilter"><option value="">All Behaviors</option></select>
            <select id="activityFilter"><option value="">All Activities</option></select>
            <select id="rarityFilter"><option value="">All Rarities</option></select>
            <select id="habitatFilter"><option value="">All Habitats</option></select>
            <button onclick="applyFilters()">Apply Filters</button>
        </div>

        <div id="filteredList"></div>
        
        <div id="searchSection">
            <input type="text" id="searchInput" placeholder="Search for a Pok√©mon...">
            <select id="searchType">
                <option value="all">All</option>
                <option value="name">Name</option>
                <option value="id">ID</option>
                <option value="type">Type</option>
                <option value="ability">Ability</option>
            </select>
            <button id="searchButton">Search</button>
        </div>

    </div>

    <div id="results"></div>

    <div id="moveSearch" style="display: none;">
        <h2>Move Database</h2>
        <input type="text" id="moveSearchInput" placeholder="Search for a move or Pok√©mon...">
        <input type="number" id="pokemonLevelInput" min="1" max="20" value="20" placeholder="Pok√©mon Level">
        <button onclick="searchMoves()">Search Moves</button>
        <div id="moveResults"></div>
    </div>

    <script>
    // Constants
    const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/images/';
    const IMAGE_FORMATS = ['png', 'jpg', 'jpeg', 'jfif'];
    const CLIENT_ID = '640296952332-niust59g0mgdci7btsjobfkvaarppfuf.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDaQqh54K_B3YhQZny6BQrhSpNwrnRyWBk';
    const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
    const REGISTERED_POKEMON_URL = 'https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/registered_pokemon.json';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
    const ITEMS_PER_PAGE = 5;
    const RESULTS_PER_PAGE = 5;

    // Global variables
    let isSoundEnabled = true;
    let tokenClient;
    let pokemonData = [];
    let moveData = [];
    let registeredPokemon = {
        names: new Set(),
        lastFetched: 0
    };
    let filterOptions = {
        types: new Set(),
        sizes: new Set(),
        behaviors: new Set(),
        activities: new Set(),
        rarities: new Set(),
        habitats: new Set()
    };
    let filteredPokemon = [];
    let currentPage = 1;
    let currentResults = [];
    let currentFilteredPage = 1;

    // Utility functions
    function playLoadingCompleteSound() {
        if (isSoundEnabled) {
            const sound = document.getElementById('loadingCompleteSound');
            sound.play()
                .then(() => {
                    console.log('Sound played successfully');
                })
                .catch(error => console.error('Error playing sound:', error));
        }
    }

    function playSearchSelectSound() {
        if (isSoundEnabled) {
            const sound = document.getElementById('searchSelect');
            sound.play()
                .then(() => {
                    console.log('Sound played successfully');
                })
                .catch(error => console.error('Error playing sound:', error));
        }
    }

    function toggleSound() {
        isSoundEnabled = !isSoundEnabled;
        const soundButton = document.getElementById('toggleSound');
        soundButton.textContent = isSoundEnabled ? 'üîä' : 'üîá';
        if (!isSoundEnabled) {
            document.getElementById('loadingCompleteNotification').style.display = 'none';
        }
    }
    
    function sanitizeFileName(name) {
        return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    }

    function showError(message) {
        const errorElement = document.createElement('div');
        errorElement.textContent = `Error: ${message}`;
        errorElement.style.color = 'red';
        errorElement.style.marginTop = '10px';
        document.body.appendChild(errorElement);
        setTimeout(() => errorElement.remove(), 5000); // Remove after 5 seconds
    }

    function showLoading() {
        const loadingIndicator = document.createElement('div');
        loadingIndicator.id = 'loadingIndicator';
        loadingIndicator.textContent = 'Loading...';
        loadingIndicator.style.position = 'fixed';
        loadingIndicator.style.top = '50%';
        loadingIndicator.style.left = '50%';
        loadingIndicator.style.transform = 'translate(-50%, -50%)';
        loadingIndicator.style.padding = '20px';
        loadingIndicator.style.background = 'rgba(0, 0, 0, 0.7)';
        loadingIndicator.style.color = 'white';
        loadingIndicator.style.borderRadius = '5px';
        loadingIndicator.style.zIndex = '1000';
        document.body.appendChild(loadingIndicator);
    }

    function hideLoading() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.textContent = 'Loading complete. Click to dismiss.';
            loadingIndicator.style.cursor = 'pointer';
            loadingIndicator.onclick = function() {
                loadingIndicator.remove();
                playLoadingCompleteSound();
            };
        }
    }

    function showPokemonSearch() {
    document.getElementById('pokemonSearch').style.display = 'block';
    document.getElementById('moveSearch').style.display = 'none';
    playSearchSelectSound();
    
    // Clear Move search results
    document.getElementById('moveResults').innerHTML = '';
    
    // Clear Move search input
    document.getElementById('moveSearchInput').value = '';
    }

    function showMoveSearch() {
        document.getElementById('pokemonSearch').style.display = 'none';
        document.getElementById('moveSearch').style.display = 'block';
        playSearchSelectSound();
        
        // Clear Pok√©mon search results
        document.getElementById('results').innerHTML = '';
        
        // Clear Pok√©mon search input
        document.getElementById('searchInput').value = '';
        
        // Reset currentResults and currentPage
        currentResults = [];
        currentPage = 1;
    }

    // Pok√©mon data functions
    async function fetchRegisteredPokemon() {
        const now = Date.now();
        if (now - registeredPokemon.lastFetched < CACHE_DURATION) {
            console.log('Using cached registered Pok√©mon');
            return;
        }

        try {
            console.log('Fetching registered Pok√©mon from:', REGISTERED_POKEMON_URL);
            const response = await fetch(REGISTERED_POKEMON_URL);
            if (!response.ok) {
                throw new Error('Failed to fetch registered Pok√©mon');
            }
            const data = await response.json();
            console.log('Fetched data:', data);
            registeredPokemon.names = new Set(data.registered.map(name => name.toLowerCase()));
            registeredPokemon.lastFetched = now;
            console.log(`Fetched ${registeredPokemon.names.size} registered Pok√©mon:`, Array.from(registeredPokemon.names));
        } catch (error) {
            console.error('Error fetching registered Pok√©mon:', error);
        }
        updateFilterOptions();
    }

    async function loadPokemonData() {
        showLoading();
        try {
            await loadMoveData();
            await fetchRegisteredPokemon();
            const response = await fetch('https://script.google.com/macros/s/AKfycbz5jkSQ1HuCpCrbg_mePsfLDaoesjCvrX_fCAhJvTC5V3IddYmtjVJnh4_2YaX37Dkj/exec?action=pokemon');
            if (!response.ok) {
                throw new Error('Failed to fetch Pok√©mon data');
            }
            const values = await response.json();
            pokemonData = await Promise.all(values.map(processPokemonRow));
        console.log('Pok√©mon data processed:', pokemonData.length, 'Pok√©mon');
        } catch (error) {
            console.error('Error loading Pok√©mon data:', error);
            showError('Failed to load Pok√©mon data. Please try again later.');
        } finally {
            hideLoading();
        }
        updateFilterOptions();
        document.getElementById('pokedex_button').style.display = 'inline-block';
        document.getElementById('move_button').style.display = 'inline-block';
    }

    function updateFilterOptions() {
        filterOptions = {
            types: new Set(),
            sizes: new Set(),
            behaviors: new Set(),
            activities: new Set(),
            rarities: new Set(),
            habitats: new Set()
        };

        pokemonData.forEach(pokemon => {
            if (registeredPokemon.names.has(pokemon.name.toLowerCase())) {
                filterOptions.types.add(pokemon.primaryType);
                if (pokemon.secondaryType) filterOptions.types.add(pokemon.secondaryType);
                filterOptions.sizes.add(pokemon.size);
                filterOptions.behaviors.add(pokemon.behavior);
                filterOptions.activities.add(pokemon.activityTime);
                filterOptions.rarities.add(pokemon.rarity);
                filterOptions.habitats.add(pokemon.habitat);
            }
        });

        populateFilterDropdowns();
    }

    function populateFilterDropdowns() {
        populateSelect('typeFilter', filterOptions.types);
        populateSelect('sizeFilter', filterOptions.sizes);
        populateSelect('behaviorFilter', filterOptions.behaviors);
        populateSelect('activityFilter', filterOptions.activities);
        populateSelect('rarityFilter', filterOptions.rarities);
        populateSelect('habitatFilter', filterOptions.habitats);
    }

    function populateSelect(id, options) {
        const select = document.getElementById(id);
        let allText = `All ${id.replace('Filter', 's')}`;
        
        // Special cases for correct pluralization
        if (id === 'rarityFilter') {
            allText = 'All rarities';
        } else if (id === 'activityFilter') {
            allText = 'All activities';
        }
        
        select.innerHTML = `<option value="">${allText}</option>`;
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            select.appendChild(optionElement);
        });
    }

    function applyFilters() {
        const typeFilter = document.getElementById('typeFilter').value;
        const sizeFilter = document.getElementById('sizeFilter').value;
        const behaviorFilter = document.getElementById('behaviorFilter').value;
        const activityFilter = document.getElementById('activityFilter').value;
        const rarityFilter = document.getElementById('rarityFilter').value;
        const habitatFilter = document.getElementById('habitatFilter').value;

        console.log('Applying filters:', { typeFilter, sizeFilter, behaviorFilter, activityFilter, rarityFilter, habitatFilter });

        filteredPokemon = pokemonData.filter(pokemon => 
            registeredPokemon.names.has(pokemon.name.toLowerCase()) &&
            (!typeFilter || pokemon.primaryType === typeFilter || pokemon.secondaryType === typeFilter) &&
            (!sizeFilter || pokemon.size === sizeFilter) &&
            (!behaviorFilter || pokemon.behavior === behaviorFilter) &&
            (!activityFilter || pokemon.activityTime === activityFilter) &&
            (!rarityFilter || pokemon.rarity === rarityFilter) &&
            (!habitatFilter || pokemon.habitat === habitatFilter)
        );

        console.log('Filtered Pok√©mon:', filteredPokemon.length);
        currentFilteredPage = 1;
        displayFilteredList();
    }

    function displayFilteredList() {
        const listContainer = document.getElementById('filteredList');
        listContainer.innerHTML = '<h3>Filtered Pok√©mon List:</h3>';
        
        console.log('Displaying filtered list. Filtered Pok√©mon:', filteredPokemon.length);
        
        if (filteredPokemon.length === 0) {
            listContainer.innerHTML += '<p>No Pok√©mon match the selected filters.</p>';
        } else {
            const totalPages = Math.ceil(filteredPokemon.length / ITEMS_PER_PAGE);
            const startIndex = (currentFilteredPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredPokemon.length);
            const ul = document.createElement('ul');
            
            for (let i = startIndex; i < endIndex; i++) {
                const pokemon = filteredPokemon[i];
                const li = document.createElement('li');
                li.textContent = `${pokemon.name} (#${pokemon.id})`;
                ul.appendChild(li);
            }
            
            listContainer.appendChild(ul);
            // Add pagination controls for filtered results
            const paginationControls = createFilterPaginationControls(filteredPokemon.length, ITEMS_PER_PAGE, currentFilteredPage, (newPage) => {
                currentFilteredPage = newPage;
                displayFilteredList();
            });
            listContainer.appendChild(paginationControls);
        }
    }

    async function processPokemonRow(row) {
        const imageUrl = await getImageUrl(row[2], row[1]);
        // Debug
        // console.log(`Processing Pok√©mon: ${row[2]}`);
        // console.log(`Primary Ability: ${row[15]}, Description: ${row[62]}`);
        // console.log(`Secondary Ability: ${row[16]}, Description: ${row[63]}`);
        // console.log(`Hidden Ability: ${row[17]}, Description: ${row[64]}`);
        return {
            image: imageUrl,
            id: row[1],
            name: row[2],
            classification: row[5],
            flavorText: row[6],
            primaryType: row[7],
            secondaryType: row[8],
            size: row[9],
            rarity: row[10],
            habitat: row[11],
            behavior: row[12],
            activityTime: row[13],
            evolutionReq: row[14],
            primaryAbility: { name: row[15], description: row[62] ?? "No description available" },
            secondaryAbility: row[16] ? { name: row[16], description: row[63] ?? "No description available" } : null,
            hiddenAbility: row[17] ? { name: row[17], description: row[64] ?? "No description available" } : null,
            catchDifficulty: row[18],
            level: row[19],
            ac: row[20],
            hitDice: row[21],
            hp: row[22],
            vitalityDice: row[23],
            vp: row[24],
            speed: row[25],
            strength: row[27],
            dexterity: row[28],
            constitution: row[29],
            intelligence: row[30],
            wisdom: row[31],
            charisma: row[32],
            savingThrows: row[33],
            skills: row[34],
            moves: {
                starting: row[35],
                level2: row[36],
                level6: row[37],
                level10: row[38],
                level14: row[39],
                level18: row[40]
            },
            movePool: row.slice(41, 62).filter(move => move !== ""),
        };
    }

    async function getImageUrl(pokemonName, pokemonId) {
        const paddedId = pokemonId.toString().padStart(3, '0');
        const sanitizedName = sanitizeFileName(pokemonName);
        const baseFileName = `${paddedId}-${sanitizedName}`;
        for (const format of IMAGE_FORMATS) {
            const url = `${IMAGE_BASE_URL}${baseFileName}.${format}`;
            if (await imageExists(url)) {
                return url;
            }
        }
        return null;
    }

    function imageExists(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = url;
        });
    }

    // Search and display functions
    function searchPokemon() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const searchType = document.getElementById('searchType').value;

        currentResults = pokemonData.filter(pokemon => {
            if (!pokemon || typeof pokemon !== 'object') return false;

            const isRegistered = registeredPokemon.names.has(pokemon.name.toLowerCase());
            if (!isRegistered) return false;

            switch(searchType) {
                case 'name':
                    return pokemon.name.toLowerCase().includes(searchTerm);
                case 'id':
                    return pokemon.id.includes(searchTerm);
                case 'type':
                    return pokemon.primaryType.toLowerCase().includes(searchTerm) || 
                        (pokemon.secondaryType && pokemon.secondaryType.toLowerCase().includes(searchTerm));
                case 'ability':
                    return pokemon.primaryAbility.toLowerCase().includes(searchTerm) ||
                        (pokemon.secondaryAbility && pokemon.secondaryAbility.toLowerCase().includes(searchTerm)) ||
                        (pokemon.hiddenAbility && pokemon.hiddenAbility.toLowerCase().includes(searchTerm));
                case 'all':
                default:
                    return pokemon.name.toLowerCase().includes(searchTerm) || 
                        pokemon.id.includes(searchTerm) ||
                        pokemon.primaryType.toLowerCase().includes(searchTerm) ||
                        (pokemon.secondaryType && pokemon.secondaryType.toLowerCase().includes(searchTerm)) ||
                        pokemon.primaryAbility.toLowerCase().includes(searchTerm) ||
                        (pokemon.secondaryAbility && pokemon.secondaryAbility.toLowerCase().includes(searchTerm)) ||
                        (pokemon.hiddenAbility && pokemon.hiddenAbility.toLowerCase().includes(searchTerm));
            }
        });

        currentPage = 1;
        displayResults();
    }

    function displayResults() {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = '';
        
        console.log('Displaying results. Current results:', currentResults.length);
        
        if (currentResults.length === 0) {
            resultsContainer.innerHTML = '<p>No Pok√©mon found. Try a different search term.</p>';
        } else {
            const totalPages = Math.ceil(currentResults.length / RESULTS_PER_PAGE);
            const startIndex = (currentPage - 1) * RESULTS_PER_PAGE;
            const endIndex = Math.min(startIndex + RESULTS_PER_PAGE, currentResults.length);
            
            const resultsInfo = document.createElement('p');
            resultsInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${currentResults.length} results`;
            resultsContainer.appendChild(resultsInfo);
            
            for (let i = startIndex; i < endIndex; i++) {
                const pokemonCard = createPokemonCard(currentResults[i]);
                resultsContainer.appendChild(pokemonCard);
            }
            
            // Add bottom pagination
            if (currentResults.length > RESULTS_PER_PAGE) {
                resultsContainer.appendChild(createPaginationControls());
            }
        }
    }

    function createFilterPaginationControls(totalItems, itemsPerPage, currentPage, onPageChange) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const controls = document.createElement('div');
        controls.className = 'pagination-controls';
        
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.onclick = () => {
            if (currentPage > 1) {
                onPageChange(currentPage - 1);
            }
        };
        prevButton.disabled = currentPage === 1;
        
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                onPageChange(currentPage + 1);
            }
        };
        nextButton.disabled = currentPage === totalPages;
        
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        
        controls.appendChild(prevButton);
        controls.appendChild(pageInfo);
        controls.appendChild(nextButton);
        
        return controls;
    }

    function createPaginationControls() {
        const totalPages = Math.ceil(currentResults.length / RESULTS_PER_PAGE);
        const controls = document.createElement('div');
        controls.className = 'pagination-controls';
        
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                displayResults();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        prevButton.disabled = currentPage === 1;
        
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                displayResults();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        nextButton.disabled = currentPage === totalPages;
        
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        
        controls.appendChild(prevButton);
        controls.appendChild(pageInfo);
        controls.appendChild(nextButton);
        
        return controls;
    }

    function createPokemonCard(pokemon) {
        const pokemonCard = document.createElement('div');
        pokemonCard.className = 'pokemon-card';
        let abilitiesHtml = '<h3>Abilities:</h3><ul>';
    
        if (pokemon.primaryAbility && pokemon.primaryAbility.name) {
            abilitiesHtml += `<li><strong>${pokemon.primaryAbility.name}:</strong> ${pokemon.primaryAbility.description}</li>`;
        }
        
        if (pokemon.secondaryAbility && pokemon.secondaryAbility.name) {
            abilitiesHtml += `<li><strong>${pokemon.secondaryAbility.name}:</strong> ${pokemon.secondaryAbility.description}</li>`;
        }
        
        if (pokemon.hiddenAbility && pokemon.hiddenAbility.name) {
            abilitiesHtml += `<li><strong>${pokemon.hiddenAbility.name} (Hidden):</strong> ${pokemon.hiddenAbility.description}</li>`;
        }
        
        abilitiesHtml += '</ul>';

        const primaryAbilityHtml = pokemon.primaryAbility ? 
            `<li><strong>${pokemon.primaryAbility.name}:</strong> ${pokemon.primaryAbility.description}</li>` : '';
        const secondaryAbilityHtml = pokemon.secondaryAbility ? 
            `<li><strong>${pokemon.secondaryAbility.name}:</strong> ${pokemon.secondaryAbility.description}</li>` : '';
        const hiddenAbilityHtml = pokemon.hiddenAbility ? 
            `<li><strong>${pokemon.hiddenAbility.name} (Hidden):</strong> ${pokemon.hiddenAbility.description}</li>` : '';

        pokemonCard.innerHTML = `
            <h2>${pokemon.name} (#${pokemon.id})</h2>
            ${pokemon.image ? `<img src="${pokemon.image}" alt="${pokemon.name}" style="max-width: 200px;">` : ''}
            <p><strong>Types:</strong> ${pokemon.primaryType}${pokemon.secondaryType ? '/' + pokemon.secondaryType : ''}</p>
            <p><strong>Size:</strong> ${pokemon.size}</p>
            <p><strong>Rarity:</strong> ${pokemon.rarity}</p>
            <p><strong>Behavior:</strong> ${pokemon.behavior}</p>
            <p><strong>Habitat:</strong> ${pokemon.habitat}</p>
            <p><strong>Classification:</strong> ${pokemon.classification}</p>
            <p><strong>Description:</strong> ${pokemon.flavorText}</p>
            <h3>Abilities:</h3>
            <ul>
                ${abilitiesHtml}
            </ul>
            <h3>Stats:</h3>
            <ul>
                <li><strong>Hit Dice:</strong> ${pokemon.hitDice}</li>
                <li><strong>Vitality Dice:</strong> ${pokemon.vitalityDice}</li>
                <li><strong>Strength:</strong> ${pokemon.strength}</li>
                <li><strong>Dexterity:</strong> ${pokemon.dexterity}</li>
                <li><strong>Constitution:</strong> ${pokemon.constitution}</li>
                <li><strong>Intelligence:</strong> ${pokemon.intelligence}</li>
                <li><strong>Wisdom:</strong> ${pokemon.wisdom}</li>
                <li><strong>Charisma:</strong> ${pokemon.charisma}</li>
                <li><strong>Speed:</strong> ${pokemon.speed}</li>
            </ul>
            <h3>Available Moves:</h3>
            <ul>
                <li><strong>Starting:</strong> ${pokemon.moves.starting}</li>
                <li><strong>Level 2:</strong> ${pokemon.moves.level2}</li>
                <li><strong>Level 6:</strong> ${pokemon.moves.level6}</li>
                <li><strong>Level 10:</strong> ${pokemon.moves.level10}</li>
                <li><strong>Level 14:</strong> ${pokemon.moves.level14}</li>
                <li><strong>Level 18:</strong> ${pokemon.moves.level18}</li>
            </ul>
        `;
        return pokemonCard;
    }

    async function loadMoveData() {
        // showLoading();
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbz5jkSQ1HuCpCrbg_mePsfLDaoesjCvrX_fCAhJvTC5V3IddYmtjVJnh4_2YaX37Dkj/exec?action=moves');
            if (!response.ok) {
                throw new Error('Failed to fetch move data');
            }
            const values = await response.json();
            moveData = values.map(row => ({
                name: row[0],
                type: row[1],
                power: row[2],
                time: row[3],
                vp: row[4],
                duration: row[5],
                range: row[6],
                description: row[7],
                higher: row[8],
            }));
            console.log('Move data processed:', moveData.length, 'moves');
        } catch (error) {
            console.error('Error loading move data:', error);
        } finally {
            // hideLoading();
        }
    }

    function searchMoves() {
        const searchTerm = document.getElementById('moveSearchInput').value.toLowerCase();
        let pokemonLevel = parseInt(document.getElementById('pokemonLevelInput').value);
        if (isNaN(pokemonLevel) || pokemonLevel < 1) {
            pokemonLevel = 1;
            document.getElementById('pokemonLevelInput').value = 1;
        } else if (pokemonLevel > 20) {
            pokemonLevel = 20;
            document.getElementById('pokemonLevelInput').value = 20;
        }
        let results = [];

        // Check if the search term matches a Pok√©mon name
        const pokemon = pokemonData.find(p => p.name.toLowerCase() === searchTerm);

        if (pokemon) {
            // If it's a Pok√©mon name, filter moves from its move pool based on level
            results = getMovesUpToLevel(pokemon, pokemonLevel);
        } else {
            // If it's not a Pok√©mon name, search all moves as before
            results = moveData.filter(move => 
                move.name.toLowerCase().includes(searchTerm) ||
                move.type.toLowerCase().includes(searchTerm)
            );
        }

        displayMoveResults(results, pokemon, pokemonLevel);
    }

    function getMovesUpToLevel(pokemon, level) {
        const moveLevels = {
            1: pokemon.moves.starting.split(', '),
            2: pokemon.moves.level2.split(', '),
            6: pokemon.moves.level6.split(', '),
            10: pokemon.moves.level10.split(', '),
            14: pokemon.moves.level14.split(', '),
            18: pokemon.moves.level18.split(', ')
        };

        let availableMoves = new Set();

        for (let [moveLevel, moves] of Object.entries(moveLevels)) {
            if (level >= parseInt(moveLevel)) {
                moves.forEach(move => availableMoves.add(move));
            }
        }

        return moveData.filter(move => availableMoves.has(move.name));
    }

    function displayMoveResults(results, pokemon = null, level = null) {
        const resultsContainer = document.getElementById('moveResults');
        resultsContainer.innerHTML = '';
        
        if (pokemon) {
            resultsContainer.innerHTML = `<h3>Moves for ${pokemon.name} (Level ${level})</h3>`;
        }

        if (results.length === 0) {
            resultsContainer.innerHTML += '<p>No moves found. Try a different search term or level.</p>';
        } else {
            results.forEach(move => {
                const moveCard = document.createElement('div');
                moveCard.className = 'move-card';
                moveCard.innerHTML = `
                    <h3>${move.name}</h3>
                    <p><strong>Type:</strong> ${move.type}</p>
                    <p><strong>VP Cost:</strong> ${move.vp}</p>
                    <p><strong>Move Power:</strong> ${move.power}</p>
                    <p><strong>Time:</strong> ${move.time}</p>
                    <p><strong>Duration:</strong> ${move.duration}</p>
                    <p><strong>Range:</strong> ${move.range}</p>
                    <p><strong>Effect:</strong> ${move.description}</p>
                    <p><strong>Higher Levels:</strong> ${move.higher}</p>
                `;
                resultsContainer.appendChild(moveCard);
            });
        }
    }

    // Initialize
    window.onload = async function() {
        try {
            await loadPokemonData(); // This will also load move data
            console.log('Data loaded successfully');
            document.getElementById('searchButton').addEventListener('click', searchPokemon);
        } catch (error) {
            console.error('Error loading data:', error);
        }
    };

    </script>
</body>
</html>