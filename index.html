<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©dex Search</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        .pokemon-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .pokemon-card h2 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .pokemon-card ul {
            padding-left: 20px;
        }
        #filters {
            margin-bottom: 20px;
        }
        #filters select {
            margin-right: 10px;
        }
        .pagination-controls {
            margin-top: 20px;
            text-align: center;
        }
        .pagination-controls button {
            margin: 0 10px;
        }
        .move-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <audio id="loadingCompleteSound" src="https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/SFX_TURN_ON_PC.wav" preload="auto"></audio>
    <h1>Pok√©dex Search</h1>
    <div id="loadingCompleteNotification" style="display: none; cursor: pointer; padding: 10px; background-color: #e0f7fa; border-radius: 5px; margin: 10px 0;">
        Data loaded! Click here to start searching!
    </div>
    <nav>
        <button id="pokedex_button" onclick="showPokemonSearch()" style="display: none;">Pok√©dex Search</button>
        <button id="move_button" onclick="showMoveSearch()" style="display: none;">Move Database</button>
    </nav>

    <div id="pokemonSearch" style="display: none;">
        <div id="filters">
            <select id="typeFilter"><option value="">All Types</option></select>
            <select id="sizeFilter"><option value="">All Sizes</option></select>
            <select id="behaviorFilter"><option value="">All Behaviors</option></select>
            <select id="activityFilter"><option value="">All Activities</option></select>
            <select id="rarityFilter"><option value="">All Rarities</option></select>
            <select id="habitatFilter"><option value="">All Habitats</option></select>
            <button onclick="applyFilters()">Apply Filters</button>
        </div>

        <div id="filteredList"></div>
        
        <input type="text" id="searchInput" placeholder="Search for a Pok√©mon...">
        <button id="searchButton">Search</button>

    </div>
    <div id="results"></div>

    <div id="moveSearch" style="display: none;">
        <h2>Move Database</h2>
        <input type="text" id="moveSearchInput" placeholder="Search for a move...">
        <button onclick="searchMoves()">Search Moves</button>
        <div id="moveResults"></div>
    </div>

    <script>
    // Constants
    const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/images/';
    const IMAGE_FORMATS = ['png', 'jpg', 'jpeg', 'jfif'];
    const CLIENT_ID = '640296952332-niust59g0mgdci7btsjobfkvaarppfuf.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDaQqh54K_B3YhQZny6BQrhSpNwrnRyWBk';
    const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
    const REGISTERED_POKEMON_URL = 'https://raw.githubusercontent.com/Benjakronk/shima-pokedex/main/registered_pokemon.json';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
    const ITEMS_PER_PAGE = 5;
    const RESULTS_PER_PAGE = 5;

    // Global variables
    let isSoundEnabled = true;
    let tokenClient;
    let pokemonData = [];
    let moveData = [];
    let registeredPokemon = {
        names: new Set(),
        lastFetched: 0
    };
    let filterOptions = {
        types: new Set(),
        sizes: new Set(),
        behaviors: new Set(),
        activities: new Set(),
        rarities: new Set(),
        habitats: new Set()
    };
    let filteredPokemon = [];
    let currentPage = 1;
    let currentResults = [];

    // Utility functions
    function showLoadingCompleteNotification() {
        const notification = document.getElementById('loadingCompleteNotification');
        notification.style.display = 'block';
        notification.onclick = playLoadingCompleteSound;
    }

    function playLoadingCompleteSound() {
        if (isSoundEnabled) {
            const sound = document.getElementById('loadingCompleteSound');
            sound.play()
                .then(() => {
                    console.log('Sound played successfully');
                    document.getElementById('loadingCompleteNotification').style.display = 'none';
                })
                .catch(error => console.error('Error playing sound:', error));
        }
    }

    function toggleSound() {
        isSoundEnabled = !isSoundEnabled;
        const soundButton = document.getElementById('toggleSound');
        soundButton.textContent = isSoundEnabled ? 'üîä' : 'üîá';
        if (!isSoundEnabled) {
            document.getElementById('loadingCompleteNotification').style.display = 'none';
        }
    }
    
    function sanitizeFileName(name) {
        return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    }

    function showError(message) {
        const errorElement = document.createElement('div');
        errorElement.textContent = `Error: ${message}`;
        errorElement.style.color = 'red';
        errorElement.style.marginTop = '10px';
        document.body.appendChild(errorElement);
        setTimeout(() => errorElement.remove(), 5000); // Remove after 5 seconds
    }

    function showLoading() {
        const loadingIndicator = document.createElement('div');
        loadingIndicator.id = 'loadingIndicator';
        loadingIndicator.textContent = 'Loading...';
        loadingIndicator.style.position = 'fixed';
        loadingIndicator.style.top = '50%';
        loadingIndicator.style.left = '50%';
        loadingIndicator.style.transform = 'translate(-50%, -50%)';
        loadingIndicator.style.padding = '20px';
        loadingIndicator.style.background = 'rgba(0, 0, 0, 0.7)';
        loadingIndicator.style.color = 'white';
        loadingIndicator.style.borderRadius = '5px';
        loadingIndicator.style.zIndex = '1000';
        document.body.appendChild(loadingIndicator);
    }

    function hideLoading() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
    }

    function showPokemonSearch() {
    document.getElementById('pokemonSearch').style.display = 'block';
    document.getElementById('moveSearch').style.display = 'none';
    
    // Clear Move search results
    document.getElementById('moveResults').innerHTML = '';
    
    // Clear Move search input
    document.getElementById('moveSearchInput').value = '';
    }

    function showMoveSearch() {
        document.getElementById('pokemonSearch').style.display = 'none';
        document.getElementById('moveSearch').style.display = 'block';
        
        // Clear Pok√©mon search results
        document.getElementById('results').innerHTML = '';
        
        // Clear Pok√©mon search input
        document.getElementById('searchInput').value = '';
        
        // Reset currentResults and currentPage
        currentResults = [];
        currentPage = 1;
    }

    // Pok√©mon data functions
    async function fetchRegisteredPokemon() {
        const now = Date.now();
        if (now - registeredPokemon.lastFetched < CACHE_DURATION) {
            console.log('Using cached registered Pok√©mon');
            return;
        }

        try {
            console.log('Fetching registered Pok√©mon from:', REGISTERED_POKEMON_URL);
            const response = await fetch(REGISTERED_POKEMON_URL);
            if (!response.ok) {
                throw new Error('Failed to fetch registered Pok√©mon');
            }
            const data = await response.json();
            console.log('Fetched data:', data);
            registeredPokemon.names = new Set(data.registered.map(name => name.toLowerCase()));
            registeredPokemon.lastFetched = now;
            console.log(`Fetched ${registeredPokemon.names.size} registered Pok√©mon:`, Array.from(registeredPokemon.names));
        } catch (error) {
            console.error('Error fetching registered Pok√©mon:', error);
        }
        updateFilterOptions();
    }

    async function loadPokemonData() {
        showLoading();
        try {
            await loadMoveData();
            await fetchRegisteredPokemon();
            const response = await fetch('https://script.google.com/macros/s/AKfycbxvxTKdcmzC2fKBc9cy9-Jc5BgaML3GwXZtHHRIavIZ5aKIp_ri3ofUTg43a1e2kyL_/exec?action=pokemon');
            if (!response.ok) {
                throw new Error('Failed to fetch Pok√©mon data');
            }
            const values = await response.json();
            pokemonData = await Promise.all(values.map(processPokemonRow));
            console.log('Pok√©mon data processed:', pokemonData.length, 'Pok√©mon');
            showLoadingCompleteNotification(); // Show notification instead of playing sound directly
        } catch (error) {
            console.error('Error loading Pok√©mon data:', error);
            showError('Failed to load Pok√©mon data. Please try again later.');
        } finally {
            hideLoading();
        }
        updateFilterOptions();
        document.getElementById('pokedex_button').style.display = 'inline-block';
        document.getElementById('move_button').style.display = 'inline-block';
    }

    function updateFilterOptions() {
        filterOptions = {
            types: new Set(),
            sizes: new Set(),
            behaviors: new Set(),
            activities: new Set(),
            rarities: new Set(),
            habitats: new Set()
        };

        pokemonData.forEach(pokemon => {
            if (registeredPokemon.names.has(pokemon.name.toLowerCase())) {
                filterOptions.types.add(pokemon.primaryType);
                if (pokemon.secondaryType) filterOptions.types.add(pokemon.secondaryType);
                filterOptions.sizes.add(pokemon.size);
                filterOptions.behaviors.add(pokemon.behavior);
                filterOptions.activities.add(pokemon.activityTime);
                filterOptions.rarities.add(pokemon.rarity);
                filterOptions.habitats.add(pokemon.habitat);
            }
        });

        populateFilterDropdowns();
    }

    function populateFilterDropdowns() {
        populateSelect('typeFilter', filterOptions.types);
        populateSelect('sizeFilter', filterOptions.sizes);
        populateSelect('behaviorFilter', filterOptions.behaviors);
        populateSelect('activityFilter', filterOptions.activities);
        populateSelect('rarityFilter', filterOptions.rarities);
        populateSelect('habitatFilter', filterOptions.habitats);
    }

    function populateSelect(id, options) {
        const select = document.getElementById(id);
        select.innerHTML = `<option value="">All ${id.replace('Filter', 's')}</option>`;
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            select.appendChild(optionElement);
        });
    }

    function applyFilters() {
        const typeFilter = document.getElementById('typeFilter').value;
        const sizeFilter = document.getElementById('sizeFilter').value;
        const behaviorFilter = document.getElementById('behaviorFilter').value;
        const activityFilter = document.getElementById('activityFilter').value;
        const rarityFilter = document.getElementById('rarityFilter').value;
        const habitatFilter = document.getElementById('habitatFilter').value;

        console.log('Applying filters:', { typeFilter, sizeFilter, behaviorFilter, activityFilter, rarityFilter, habitatFilter });

        filteredPokemon = pokemonData.filter(pokemon => 
            registeredPokemon.names.has(pokemon.name.toLowerCase()) &&
            (!typeFilter || pokemon.primaryType === typeFilter || pokemon.secondaryType === typeFilter) &&
            (!sizeFilter || pokemon.size === sizeFilter) &&
            (!behaviorFilter || pokemon.behavior === behaviorFilter) &&
            (!activityFilter || pokemon.activityTime === activityFilter) &&
            (!rarityFilter || pokemon.rarity === rarityFilter) &&
            (!habitatFilter || pokemon.habitat === habitatFilter)
        );

        console.log('Filtered Pok√©mon:', filteredPokemon.length);
        currentPage = 1;
        displayFilteredList();
    }

    function displayFilteredList() {
        const listContainer = document.getElementById('filteredList');
        listContainer.innerHTML = '<h3>Filtered Pok√©mon List:</h3>';
        
        console.log('Displaying filtered list. Filtered Pok√©mon:', filteredPokemon.length);
        
        if (filteredPokemon.length === 0) {
            listContainer.innerHTML += '<p>No Pok√©mon match the selected filters.</p>';
        } else {
            const totalPages = Math.ceil(filteredPokemon.length / ITEMS_PER_PAGE);
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredPokemon.length);
            const ul = document.createElement('ul');
            
            for (let i = startIndex; i < endIndex; i++) {
                const pokemon = filteredPokemon[i];
                const li = document.createElement('li');
                li.textContent = `${pokemon.name} (#${pokemon.id})`;
                ul.appendChild(li);
            }
            
            listContainer.appendChild(ul);
            // Add pagination controls
            const paginationControls = createPaginationControls(filteredPokemon.length, ITEMS_PER_PAGE, currentPage, (newPage) => {
                currentPage = newPage;
                displayFilteredList();
            });
            listContainer.appendChild(paginationControls);
        }
    }

    async function processPokemonRow(row) {
        const imageUrl = await getImageUrl(row[2], row[1]);
        return {
            image: imageUrl,
            id: row[1],
            name: row[2],
            classification: row[5],
            flavorText: row[6],
            primaryType: row[7],
            secondaryType: row[8],
            size: row[9],
            rarity: row[10],
            habitat: row[11],
            behavior: row[12],
            activityTime: row[13],
            evolutionReq: row[14],
            primaryAbility: row[15],
            secondaryAbility: row[16],
            hiddenAbility: row[17],
            catchDifficulty: row[18],
            level: row[19],
            ac: row[20],
            hitDice: row[21],
            hp: row[22],
            vitalityDice: row[23],
            vp: row[24],
            speed: row[25],
            strength: row[27],
            dexterity: row[28],
            constitution: row[29],
            intelligence: row[30],
            wisdom: row[31],
            charisma: row[32],
            savingThrows: row[33],
            skills: row[34],
            moves: {
                starting: row[35],
                level2: row[36],
                level6: row[37],
                level10: row[38],
                level14: row[39],
                level18: row[40]
            }
        };
    }

    async function getImageUrl(pokemonName, pokemonId) {
        const paddedId = pokemonId.toString().padStart(3, '0');
        const sanitizedName = sanitizeFileName(pokemonName);
        const baseFileName = `${paddedId}-${sanitizedName}`;
        for (const format of IMAGE_FORMATS) {
            const url = `${IMAGE_BASE_URL}${baseFileName}.${format}`;
            if (await imageExists(url)) {
                return url;
            }
        }
        return null;
    }

    function imageExists(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = url;
        });
    }

    // Search and display functions
    function searchPokemon() {
        console.log('searchPokemon function called');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        console.log('Searching for:', searchTerm);
        console.log('Total Pok√©mon data:', pokemonData.length);
        console.log('Registered Pok√©mon:', registeredPokemon.names.size);

        currentResults = pokemonData.filter(pokemon => {
            if (!pokemon || typeof pokemon !== 'object') {
                console.warn('Invalid pokemon object:', pokemon);
                return false;
            }

            const pokemonName = (pokemon.name || '').toLowerCase();
            const pokemonId = String(pokemon.id || ''); // Convert ID to string
            const primaryType = (pokemon.primaryType || '').toLowerCase();
            const secondaryType = (pokemon.secondaryType || '').toLowerCase();

            const isRegistered = registeredPokemon.names.has(pokemonName);
            const matchesSearch = 
                pokemonName.includes(searchTerm) || 
                pokemonId.includes(searchTerm) ||
                primaryType.includes(searchTerm) ||
                secondaryType.includes(searchTerm);
            
            return isRegistered && matchesSearch;
        });

        console.log('Search results:', currentResults.length);
        currentPage = 1;
        displayResults();
    }

    function displayResults() {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = '';
        
        console.log('Displaying results. Current results:', currentResults.length);
        
        if (currentResults.length === 0) {
            resultsContainer.innerHTML = '<p>No Pok√©mon found. Try a different search term.</p>';
        } else {
            const totalPages = Math.ceil(currentResults.length / RESULTS_PER_PAGE);
            const startIndex = (currentPage - 1) * RESULTS_PER_PAGE;
            const endIndex = Math.min(startIndex + RESULTS_PER_PAGE, currentResults.length);
            
            function createPaginationControlsWithCallback() {
                return createPaginationControls(
                    currentResults.length,
                    RESULTS_PER_PAGE,
                    currentPage,
                    (newPage) => {
                        currentPage = newPage;
                        displayResults();
                        resultsContainer.scrollIntoView({ behavior: 'smooth' });
                    }
                );
            }

            // Add top pagination
            if (currentResults.length > RESULTS_PER_PAGE) {
                resultsContainer.appendChild(createPaginationControlsWithCallback());
            }

            resultsContainer.innerHTML += `<p>Showing ${startIndex + 1}-${endIndex} of ${currentResults.length} results</p>`;
            
            for (let i = startIndex; i < endIndex; i++) {
                const pokemonCard = createPokemonCard(currentResults[i]);
                resultsContainer.appendChild(pokemonCard);
            }
            
            // Add bottom pagination
            if (currentResults.length > RESULTS_PER_PAGE) {
                resultsContainer.appendChild(createPaginationControlsWithCallback());
            }
        }
    }

    function createPaginationControls(totalItems, itemsPerPage, currentPage, onPageChange) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const controls = document.createElement('div');
        controls.className = 'pagination-controls';
        
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.onclick = () => {
            if (currentPage > 1) {
                onPageChange(currentPage - 1);
            }
        };
        prevButton.disabled = currentPage === 1;
        
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                onPageChange(currentPage + 1);
            }
        };
        nextButton.disabled = currentPage === totalPages;
        
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        
        controls.appendChild(prevButton);
        controls.appendChild(pageInfo);
        controls.appendChild(nextButton);
        
        return controls;
    }

    function createPokemonCard(pokemon) {
        const pokemonCard = document.createElement('div');
        pokemonCard.className = 'pokemon-card';
        pokemonCard.innerHTML = `
            <h2>${pokemon.name} (#${pokemon.id})</h2>
            ${pokemon.image ? `<img src="${pokemon.image}" alt="${pokemon.name}" style="max-width: 200px;">` : ''}
            <p><strong>Types:</strong> ${pokemon.primaryType}${pokemon.secondaryType ? '/' + pokemon.secondaryType : ''}</p>
            <p><strong>Size:</strong> ${pokemon.size}</p>
            <p><strong>Rarity:</strong> ${pokemon.rarity}</p>
            <p><strong>Behavior:</strong> ${pokemon.behavior}</p>
            <p><strong>Habitat:</strong> ${pokemon.habitat}</p>
            <p><strong>Classification:</strong> ${pokemon.classification}</p>
            <p><strong>Flavor Text:</strong> ${pokemon.flavorText}</p>
            <h3>Abilities:</h3>
            <ul>
                <li><strong>Primary:</strong> ${pokemon.primaryAbility}</li>
                ${pokemon.secondaryAbility ? `<li><strong>Secondary:</strong> ${pokemon.secondaryAbility}</li>` : ''}
                ${pokemon.hiddenAbility ? `<li><strong>Hidden:</strong> ${pokemon.hiddenAbility}</li>` : ''}
            </ul>
            <h3>Stats:</h3>
            <ul>
                <li><strong>Hit Dice:</strong> ${pokemon.hitDice}</li>
                <li><strong>Vitality Dice:</strong> ${pokemon.vitalityDice}</li>
                <li><strong>Strength:</strong> ${pokemon.strength}</li>
                <li><strong>Dexterity:</strong> ${pokemon.dexterity}</li>
                <li><strong>Constitution:</strong> ${pokemon.constitution}</li>
                <li><strong>Intelligence:</strong> ${pokemon.intelligence}</li>
                <li><strong>Wisdom:</strong> ${pokemon.wisdom}</li>
                <li><strong>Charisma:</strong> ${pokemon.charisma}</li>
                <li><strong>Speed:</strong> ${pokemon.speed}</li>
            </ul>
            <h3>Available Moves:</h3>
            <ul>
                <li><strong>Starting:</strong> ${pokemon.moves.starting}</li>
                <li><strong>Level 2:</strong> ${pokemon.moves.level2}</li>
                <li><strong>Level 6:</strong> ${pokemon.moves.level6}</li>
                <li><strong>Level 10:</strong> ${pokemon.moves.level10}</li>
                <li><strong>Level 14:</strong> ${pokemon.moves.level14}</li>
                <li><strong>Level 18:</strong> ${pokemon.moves.level18}</li>
            </ul>
        `;
        return pokemonCard;
    }

    async function loadMoveData() {
        showLoading();
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbxvxTKdcmzC2fKBc9cy9-Jc5BgaML3GwXZtHHRIavIZ5aKIp_ri3ofUTg43a1e2kyL_/exec?action=moves');
            if (!response.ok) {
                throw new Error('Failed to fetch move data');
            }
            const values = await response.json();
            moveData = values.map(row => ({
                name: row[0],
                type: row[1],
                power: row[2],
                time: row[3],
                vp: row[4],
                duration: row[5],
                range: row[6],
                description: row[7],
                higher: row[8],
            }));
            console.log('Move data processed:', moveData.length, 'moves');
        } catch (error) {
            console.error('Error loading move data:', error);
        } finally {
            hideLoading();
        }
    }

    function searchMoves() {
        const searchTerm = document.getElementById('moveSearchInput').value.toLowerCase();
        const results = moveData.filter(move => 
            move.name.toLowerCase().includes(searchTerm) ||
            move.type.toLowerCase().includes(searchTerm)
        );
        displayMoveResults(results);
    }

    function displayMoveResults(results) {
        const resultsContainer = document.getElementById('moveResults');
        resultsContainer.innerHTML = '';
        if (results.length === 0) {
            resultsContainer.innerHTML = '<p>No moves found. Try a different search term.</p>';
        } else {
            results.forEach(move => {
                const moveCard = document.createElement('div');
                moveCard.className = 'move-card';
                moveCard.innerHTML = `
                    <h3>${move.name}</h3>
                    <p><strong>Type:</strong> ${move.type}</p>
                    <p><strong>VP Cost:</strong> ${move.vp}</p>
                    <p><strong>Move Power:</strong> ${move.power}</p>
                    <p><strong>Time:</strong> ${move.time}</p>
                    <p><strong>Duration:</strong> ${move.duration}</p>
                    <p><strong>Range:</strong> ${move.range}</p>
                    <p><strong>Effect:</strong> ${move.description}</p>
                    <p><strong>Higher Levels:</strong> ${move.higher}</p>
                `;
                resultsContainer.appendChild(moveCard);
            });
        }
    }

    // Initialize
    window.onload = async function() {
        try {
            await loadPokemonData(); // This will also load move data
            console.log('Data loaded successfully');
            document.getElementById('searchButton').addEventListener('click', searchPokemon);
        } catch (error) {
            console.error('Error loading data:', error);
        }
    };

    </script>
</body>
</html>